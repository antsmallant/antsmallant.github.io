---
layout: post
title: "lua vm 六: lua 服务器热更新"
date: 2024-04-13
last_modified_at: 2024-04-13
categories: [lua]
tags: [lua]
---

* 目录  
{:toc}
<br/>

---

# 1. lua 服务器热更新

前言已经提到 upvalue 给热更新带来的麻烦，我日常开发中，使用的比较多的是 skynet，所以下面以 skynet 为例来讲。   

首先，在实际使用中，我们并不真正的做热更新，即不做功能上的热更新；而是做一些 “热修复”，即修复一些 bug。  

功能上的热更新，应该是通过架构层面上的设计来实现，因为它要考虑的问题会更多，如果没搞好，玩家的数据状态可能就不一致了，得不偿失，这个话题暂且不说。   

热修复，就是用新代码替换旧代码，前言也提到了，没法简单的替换，要把旧函数上的 upvalue 找出来，绑定到新函数上。   

---

## 1.1 skynet 热修复   

这篇文章 《Lua 服务端热更新》[1] 的作者提到了一种比较 “通用” 的办法，但在实际生产环境中，这种遍历的方式，可能会非常耗时，并导致服务端出现卡顿，所以，这种遍历的做法，比较适合轻负载的，对帧率要求不高的游戏。    

在 skynet 下，我们生产上使用的 hotfix 方式是点对点的，即只修复特定需要修复的函数。skynet 暴露了 inject 接口，可以在一个服务中执行一份代码文件，这份代码文件我们可以写上新函数，然后利用 lua 的 debug 库完全 upvalue 的重新绑定。  

大体实现差不多是这样：  

```lua

```

不过，这里面有些状况是需要特别考虑的，就是新函数可能依赖了旧函数（闭包）上没有的 upvalue，这种情况可能会被我们忽略掉。  


---

# 2. 参考

[1] yuerer. Lua 服务端热更新. Available at https://yuerer.com/Lua服务端热更新/, 2020-12-19.     