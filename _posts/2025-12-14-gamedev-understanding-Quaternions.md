---
layout: post
title: "游戏开发笔记：理解四元数"
date: 2025-12-14
last_modified_at: 2025-12-14
categories: [游戏开发]
tags: [game]
---

* 目录  
{:toc}
<br/>

以下是 gemini 给的，很简洁清晰。   

---

## 一、关于四元数

理解四元数（Quaternion）确实是一个挑战，因为它们涉及到**四维空间**的数学，不仅难以在脑海中通过图像直观构想，而且其运算法则也比较反直觉。

为了让你真正理解它，我们不能只看公式。我们需要**从你已经熟悉的知识出发，一步步搭建通往四元数的桥梁**。

我们将分四个步骤来拆解：
1.  **类比：** 从复数（2D 旋转）推导到四元数（3D 旋转）。
2.  **结构：** 标量与向量的组合。
3.  **核心机制：** 它是如何通过“轴-角”来描述旋转的。
4.  **操作：** 那个著名的“三明治”乘积。

---

### 第一步：从复数说起（二维旋转的扩充）

要理解四元数，必须先理解**复数**。

* **实数轴（1D）：** 只有左右方向（正负）。
* **复数平面（2D）：** 我们引入虚数单位 $i$。一个复数 $z = x + yi$ 定义了平面上的一个点。
* **复数的魔法：** 当你用一个复数去乘以另一个复数时，不仅仅是数值的变化，还包含了**旋转**。
    * 特别是，如果你乘以 $i$，就相当于逆时针旋转 90 度。
    * 如果你乘以一个模长为 1 的复数（单位复数），就相当于在平面上做了一个纯粹的旋转操作。

**哈密顿的困境（Sir William Rowan Hamilton）：**
在 19 世纪，数学家哈密顿想：既然复数（$a+bi$）可以完美表示二维平面的旋转，那么是否有一个类似的“三维数”（$a+bi+cj$）来表示三维空间的旋转呢？

他尝试了很多年，发现**三维是不够的**。不管怎么定义乘法，都会产生逻辑矛盾。最后他顿悟了：**要描述三维空间的旋转，你需要进入四维空间。**

这就是四元数诞生的原因：它是复数在四维空间的推广。

---

### 第二步：四元数的解剖结构

四元数 $q$ 有 4 个分量：

$$
q = w + xi + yj + zk
$$

为了方便理解，我们可以把它拆成两部分来看：**一个标量（Scalar）** 和 **一个向量（Vector）**。

$$
q = (w, \mathbf{v})
$$

其中：
* $w$ 是**实部**（标量）。
* $\mathbf{v} = (x, y, z)$ 是**虚部**（这就构成了一个三维向量）。

这种“标量+向量”的结构非常重要，因为它直接对应了三维旋转的物理意义：**旋转需要一个轴（向量）和一个角度（标量相关）。**

---

### 第三步：核心直觉——“轴-角”表示法

这是理解四元数最关键的一点。

在三维空间中，任何一种旋转（无论怎么转，转多少圈），最终都可以等效为：**绕着某一根固定的轴，旋转了特定的角度**。这就是**欧拉旋转定理**。

四元数不仅是数学游戏，它直接把这个“轴”和“角”编码在数字里。

假设我们要绕着一个**单位轴向量** $\mathbf{u} = (u_x, u_y, u_z)$ 旋转 $\theta$ 度。对应的四元数 $q$ 写法如下：

$$
q = \cos(\frac{\theta}{2}) + \sin(\frac{\theta}{2})\mathbf{u}
$$

展开来看就是：
$w = \cos(\frac{\theta}{2})$   
$x = u_x \cdot \sin(\frac{\theta}{2})$    
$y = u_y \cdot \sin(\frac{\theta}{2})$    
$z = u_z \cdot \sin(\frac{\theta}{2})$    

> **疑问：为什么是 $\theta/2$（半角）？**
> 这是一个非常深刻的数学特性。简单来说，四元数覆盖了三维旋转群两次。
> * 旋转 360 度（$\theta=360$），$w = \cos(180^\circ) = -1$。四元数变成了 $-1$（这在几何上虽然回到了原点，但数学状态变反了）。
> * 只有旋转 720 度，四元数才会变回 $1$。
> 这个 $\theta/2$ 的设计保证了运算的连续性和消除正负歧义，让计算机在插值时更加平滑。

---

### 第四步：如何用它来旋转？（三明治积）

你有一个三维点 $P(p_x, p_y, p_z)$，想用上面的四元数 $q$ 让它旋转。

1.  **把点变成四元数：**
    我们要把三维点 $P$ 伪装成一个四元数 $p$。实部设为 0，虚部就是坐标：
    $$
    p = 0 + p_x i + p_y j + p_z k
    $$

2.  **执行“三明治”乘法：**
    旋转后的新点 $p'$ 的计算公式是：
    $$
    p' = q \cdot p \cdot q^{-1}
    $$
    （其中 $q^{-1}$ 是 $q$ 的逆，对于单位四元数，$q^{-1}$ 就是把虚部取反）。

**直觉解释：**
这个公式看起来像把 $p$ 夹在中间。
* 左边的 $q$ 施加旋转。
* 右边的 $q^{-1}$ 修正维度扭曲，确保结果仍然是一个“纯虚数四元数”（实部为0），这样我们才能把它还原回三维坐标。

---

### 第五步：为什么要这么麻烦？（对比欧拉角）

你可能会问：“用欧拉角（俯仰、偏航、翻滚）不是更直观吗？”

确实，欧拉角对人类直观，但对计算机和数学有致命缺陷：

1.  **万向锁（Gimbal Lock）：** 
    想象你在转动一个陀螺仪。如果你先把一个环转 90 度，它可能会和另一个环重合。这时候，你就失去了一个维度的旋转能力（比如这就没法区分“向左转”和“向右倾”了）。
    * **欧拉角**：是分三次先后旋转（先X，再Y，再Z）。这种依赖顺序的操作会导致轴重合。
    * **四元数**：是一次性绕着一个特定轴旋转。**它从不通过步骤来定义旋转，所以永远不会有万向锁。**

2.  **插值（Slerp）：**
    在游戏中，你想让角色平滑地从“朝向 A”转到“朝向 B”。
    * 如果你用欧拉角做插值，角色的头可能会在中间奇怪地甩一下。
    * 用四元数做**球面线性插值 (Slerp)**，计算机会沿着四维球面上最短的弧线移动。结果就是：**丝般顺滑、匀速的最短路径旋转。**

---

### 总结：如何构建心智模型

不要试图去想象四维空间长什么样。请这样理解四元数：

1.  它是一个**容器**，里面装着两样东西：**转轴**（Vector）和**转角**（Scalar）。
2.  它是一套**操作协议**，虽然乘法规则（$ij=k, ji=-k$）很奇怪，但正是这种“不可交换性”模拟了真实世界中“先低头再左转”和“先左转再低头”是不一样的这一物理事实。
3.  它是**3D 程序员的瑞士军刀**，虽然数学复杂，但它是目前人类描述 3D 旋转最完美、无死角的方法。

---

## 二、关于万向锁

光靠文字去想象“万向锁”这种三维动态问题，对谁来说都是一种折磨。

最直观的方法确实是看视频，我为你找到了图形学界公认最经典的解释视频（见文末链接），但在你点击之前，让我先用一个**不用画面的“思想实验”**来帮你打通这个概念。

这个实验只需要你的**手**和**手机**。

---

### 思想实验：手机飞行员

想象你的手机是一架飞机。屏幕朝上，充电口对着你自己。

**步骤 1：建立层级（欧拉角的规矩）**
在这个实验中，我们要严格遵守欧拉角的**旋转顺序**（假设是 Y-X-Z）：
1.  **第一层（父）：** 只能在桌面上**水平转动**（像指南针一样，Yaw）。
2.  **第二层（子）：** 只能**抬头/低头**（像手机立起来/躺下去，Pitch）。
3.  **第三层（孙）：** 只能**侧身翻滚**（像手机屏幕向左/右倾斜，Roll）。

**步骤 2：正常操作**
* 你先把手机在桌面上转个向（Yaw），没问题。
* 你把手机抬起 45 度（Pitch），没问题。
* 你让手机侧倾一下（Roll），没问题。
此时三个动作都互不干扰。

**步骤 3：触发“死锁”（关键时刻）**
现在，请把手机复位平放。我们来制造灾难：

1.  **请做一个“抬头 90 度”的动作（Pitch = 90）。**
    * 现在你的手机应该是**垂直竖立**在桌面上，屏幕正对着你的脸，充电口贴着桌面。

2.  **在这个姿态下，尝试做“第一层”动作（水平转动 Yaw）。**
    * 你要保持手机竖立，然后在桌面上转动它。
    * **观察结果：** 手机像个陀螺一样绕着垂直轴自转。屏幕还是对着你，只是左右转了。

3.  **现在，尝试做“第三层”动作（侧身翻滚 Roll）。**
    * 按照定义，Roll 是绕着手机的“长轴”转。
    * 因为手机现在是竖立的，“长轴”也是垂直的。
    * **观察结果：** 手机依然是像个陀螺一样绕着垂直轴自转。

**发现了吗？**
当手机**抬头 90 度**竖立时，**“在桌面上转（Yaw）”**和**“绕自身轴滚（Roll）”**变成了**完全一模一样**的动作。

你本来应该有三个控制方向，现在其中两个重叠了。如果你想让手机在这个竖立状态下，**向左边倒下去**（原本应该是 Yaw 负责的方向），你会发现你做不到了。你被“锁”在这个竖立的维度里了。

这就是万向锁。

---

### 推荐视频说明

文字毕竟抽象，为了彻底解决你的困惑，请观看下方这个视频。这是计算机图形学历史上**最著名**的教学视频之一，由 GuerrillaCG 制作。

**视频看点：**
1.  它使用了一个真实的**物理机械陀螺仪**。
2.  注意看 **1:50** 左右，演示者旋转中间的**绿环**。
3.  当绿环转到 90 度时，你可以清晰地看到外面的**红环**和里面的**蓝环**转轴变得**平行（重合）**了。
4.  那一刻，无论他怎么转红环或蓝环，里面的飞机都只能做同一个方向的转动。

这个视频非常短且直观，看完你一定能理解为什么“两个轴重合”会导致“失去自由度”。

[Euler (gimbal lock) Explained - GuerrillaCG](https://www.youtube.com/watch?v=zc8b2Jo7mno)

这个视频用真实的机械结构完美演示了当中间的环旋转90度时，外环和内环的旋转轴是如何重合在一起从而导致万向锁的。


http://googleusercontent.com/youtube_content/0

